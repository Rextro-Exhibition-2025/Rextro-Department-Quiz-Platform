openapi: 3.0.3
info:
  title: Rextro Quiz Platform API
  description: >
    Complete Backend API for the Rextro Quiz Platform. 

    This API handles:
    * **User Auth:** Registration and Google OAuth linking.
    * **Quiz Management:** Creating quiz sets, publishing, and retrieving questions.
    * **Live Attempts:** Logic for students opening questions and submitting answers in real-time.
    * **Leaderboards:** Aggregated ranking calculations.
    * **Asset Management:** Image uploading via Cloudinary.
  version: 1.0.0
  contact:
    name: API Support
    email: rmkavindudhananjaya@gmail.com

servers:
  - url: http://localhost:5000/api
    description: Local Development Server
  - url: https://rextro-maths-quiz-backend.vercel.app/api
    description: Production Server

tags:
  - name: Auth
    description: User authentication, registration, and account linking.
  - name: Users
    description: User profile management and administrative user lists.
  - name: Quizzes
    description: Core quiz logic, including fetching quizzes, submitting full results, and publishing sets.
  - name: Questions
    description: Admin-only CRUD operations for the question bank.
  - name: Attempts
    description: Granular, question-by-question attempt tracking for students.
  - name: Leaderboard
    description: Statistical rankings and performance metrics.
  - name: Upload
    description: Helper endpoints for image assets.

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter the token returned from /auth/register or /auth/oauth/link

  schemas:
    # --- Common Response Wrappers ---
    StandardError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Invalid credentials"
        error:
          type: string
          description: Detailed stack trace or error description (dev mode only)
          example: "User not found in database..."

    # --- Domain Models ---
    User:
      type: object
      properties:
        _id:
          type: string
          example: "65a123b3c4d5e6f7g8h9i0j1"
        name:
          type: string
          example: "Kavindu D."
        email:
          type: string
          format: email
          example: "student@rextro.lk"
        studentId:
          type: string
          description: Unique school-issued identifier
          example: "STU-2024-001"
        authProvider:
          type: string
          enum: ["local", "google"]
          example: "local"
        marks:
          type: number
          description: Cumulative score across quizzes
          example: 85.5
        createdAt:
          type: string
          format: date-time

    Option:
      type: object
      required:
        - option
      properties:
        option:
          type: string
          enum: ["A", "B", "C", "D"]
          example: "A"
        optionText:
          type: string
          example: "Pythagoras Theorem"
        optionImage:
          type: string
          format: uri
          example: "https://res.cloudinary.com/demo/image/upload/v1/options/opt_a.jpg"
        optionImagePublicId:
          type: string
          description: Cloudinary Public ID for deletion
          example: "options/opt_a"

    # Full Question (Admin View - Includes Answer)
    Question:
      type: object
      properties:
        _id:
          type: string
          example: "65b999..."
        quizId:
          type: integer
          example: 1
        question:
          type: string
          example: "Calculate the hypotenuse of a right triangle with sides 3 and 4."
        questionImage:
          type: string
          example: "https://res.cloudinary.com/..."
        questionImagePublicId:
          type: string
        options:
          type: array
          minItems: 4
          maxItems: 4
          items:
            $ref: "#/components/schemas/Option"
        correctOption:
          type: string
          enum: ["A", "B", "C", "D"]
          description: The correct answer key
          example: "C"

    # Public Question (Student View - Hides Answer)
    PublicQuestion:
      type: object
      description: Sanitized question object for students (correctOption is removed)
      properties:
        _id:
          type: string
          example: "65b999..."
        quizId:
          type: integer
          example: 1
        question:
          type: string
          example: "Calculate the hypotenuse of a right triangle with sides 3 and 4."
        questionImage:
          type: string
        questionImagePublicId:
          type: string
        options:
          type: array
          items:
            $ref: "#/components/schemas/Option"

    Quiz:
      type: object
      properties:
        _id:
          type: string
        quizId:
          type: integer
          description: Custom numeric ID for the quiz set
          example: 1
        name:
          type: string
          example: "Mathematics Term 1 Final"
        isPublished:
          type: boolean
          example: true
        questions:
          type: array
          description: List of sanitized questions
          items:
            $ref: "#/components/schemas/PublicQuestion"

    Attempt:
      type: object
      properties:
        _id:
          type: string
        student:
          type: string
          description: User ObjectId
        quizId:
          type: integer
          example: 1
        question:
          type: string
          description: Question ObjectId
        openTime:
          type: string
          format: date-time
        submitTime:
          type: string
          format: date-time
        answer:
          type: string
          example: "C"
        isCorrect:
          type: boolean
          example: true
        timeTaken:
          type: number
          description: Duration in seconds
          example: 45

    LeaderboardEntry:
      type: object
      properties:
        studentId:
          type: string
          example: "STU-001"
        name:
          type: string
          example: "John Doe"
        correctCount:
          type: integer
          example: 15
        totalQuestions:
          type: integer
          example: 20
        correctPercentage:
          type: number
          example: 75.0
        totalTimeTaken:
          type: number
          description: Total seconds
          example: 300
        attempts:
          type: integer
          description: Number of questions attempted
          example: 20

paths:
  # ==============================
  # AUTH ROUTES
  # ==============================
  /auth/register:
    post:
      tags:
        - Auth
      summary: Register a new student
      description: Registers a user with local credentials. Returns an auth token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, studentId, email]
              properties:
                name:
                  type: string
                  example: "John Doe"
                studentId:
                  type: string
                  example: "STU-2025-001"
                email:
                  type: string
                  format: email
                  example: "john@school.edu"
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      id: { type: string }
                      name: { type: string }
                      authToken:
                        { type: string, description: "JWT Bearer Token" }
        "409":
          description: Student ID or Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardError"

  /auth/oauth/link:
    post:
      tags:
        - Auth
      summary: Link Google Account
      description: Links a Google account to an existing user by email. Sets an HTTP-only cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, googleId]
              properties:
                email: { type: string, example: "john@school.edu" }
                googleId: { type: string, example: "1029384756" }
                name: { type: string, example: "John Doe" }
      responses:
        "200":
          description: Account linked successfully
        "404":
          description: User not found

  /auth/me:
    get:
      tags:
        - Auth
      summary: Get current user profile
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Returns profile and current marks
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      name: { type: string }
                      marks: { type: number }
                      authToken: { type: string }

  # ==============================
  # USER ROUTES
  # ==============================
  /users:
    get:
      tags:
        - Users
      summary: Get all users
      responses:
        "200":
          description: List of all registered users
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  count: { type: integer, example: 50 }
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"

    post:
      tags:
        - Users
      summary: Admin create user
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/User"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data: { $ref: "#/components/schemas/User" }

  /users/{id}:
    get:
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
          description: User MongoDB ID
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data: { $ref: "#/components/schemas/User" }
    put:
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/User"
      responses:
        "200":
          description: User updated
    delete:
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: User deleted

  # ==============================
  # QUIZ ROUTES
  # ==============================
  /quizzes/get-quiz-sets:
    get:
      tags:
        - Quizzes
      summary: List available quizzes
      description: Returns a lightweight list of quiz IDs and names.
      responses:
        "200":
          description: List of quizzes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        quizId: { type: integer, example: 1 }
                        name: { type: string, example: "Algebra Quiz" }

  /quizzes/create-quiz-set:
    post:
      tags:
        - Quizzes
      summary: Create a new quiz set (Admin)
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                quizId: { type: integer, example: 2 }
                name: { type: string, example: "Geometry Basics" }
                isPublished: { type: boolean, default: false }
      responses:
        "201":
          description: Quiz created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  quiz: { $ref: "#/components/schemas/Quiz" }

  /quizzes/{quizId}:
    get:
      tags:
        - Quizzes
      summary: Get full quiz details
      description: Fetches a quiz and all its questions.
      parameters:
        - name: quizId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Quiz data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  quiz: { $ref: "#/components/schemas/Quiz" }
        "404":
          description: Quiz not found
    patch:
      tags:
        - Quizzes
      summary: Update quiz metadata
      security:
        - BearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, example: "New Quiz Name" }
      responses:
        "200":
          description: Updated successfully

  /quizzes/submit-quiz:
    post:
      tags:
        - Quizzes
      summary: Submit entire quiz
      description: Calculates the final score based on all answers and updates the user's profile.
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [quizId, submittedAnswers]
              properties:
                quizId: { type: integer, example: 1 }
                submittedAnswers:
                  type: array
                  items:
                    type: object
                    properties:
                      questionId:
                        {
                          type: integer,
                          description: "Index of the question",
                          example: 0,
                        }
                      answer: { type: string, example: "A" }
      responses:
        "200":
          description: Submission processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      quizId: { type: integer }
                      score: { type: number, example: 80.0 }

  /quizzes/check-quiz-published-status:
    get:
      tags:
        - Quizzes
      summary: Check specific quiz status
      description: Hardcoded to check Quiz ID 1 currently.
      responses:
        "200":
          description: Status returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  isPublished: { type: boolean }

  /quizzes/publish-all-quizzes:
    post:
      tags:
        - Quizzes
      summary: Publish ALL quizzes (Admin)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string }

  /quizzes/unpublish-all-quizzes:
    post:
      tags:
        - Quizzes
      summary: Unpublish ALL quizzes (Admin)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Success

  /quizzes/get-leaderboard:
    get:
      tags:
        - Quizzes
      summary: Global User Leaderboard
      description: Returns top 50 users sorted by total marks.
      responses:
        "200":
          description: Top users
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        name: { type: string }
                        studentId: { type: string }
                        marks: { type: number }

  # ==============================
  # QUESTION ROUTES
  # ==============================
  /questions:
    get:
      tags:
        - Questions
      summary: Get all questions (Admin)
      description: Returns all questions including correct answers.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of all questions
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Question"
    post:
      tags:
        - Questions
      summary: Create a new question
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Question"
      responses:
        "201":
          description: Question created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data: { $ref: "#/components/schemas/Question" }

  /questions/{questionId}:
    get:
      tags:
        - Questions
      summary: Get question by ID
      security:
        - BearerAuth: []
      parameters:
        - name: questionId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Question data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data: { $ref: "#/components/schemas/Question" }
    put:
      tags:
        - Questions
      summary: Edit question
      security:
        - BearerAuth: []
      parameters:
        - name: questionId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Question"
      responses:
        "200":
          description: Updated
    delete:
      tags:
        - Questions
      summary: Delete question
      security:
        - BearerAuth: []
      parameters:
        - name: questionId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Deleted

  # ==============================
  # ATTEMPT ROUTES
  # ==============================
  /attempts/open:
    post:
      tags:
        - Attempts
      summary: Start a question attempt
      description: Records the `openTime` for a specific question to track duration.
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [quizId, questionId]
              properties:
                quizId: { type: integer, example: 1 }
                questionId: { type: string, example: "65b123..." }
      responses:
        "200":
          description: Attempt started
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data: { $ref: "#/components/schemas/Attempt" }

  /attempts/submit:
    post:
      tags:
        - Attempts
      summary: Submit single question answer
      description: Validates answer, records `submitTime`, calculates `timeTaken`, and stores result.
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [quizId, questionId, answer]
              properties:
                quizId: { type: integer, example: 1 }
                questionId: { type: string, example: "65b123..." }
                answer: { type: string, example: "C" }
      responses:
        "200":
          description: Answer submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  isCorrect: { type: boolean, example: true }
                  data: { $ref: "#/components/schemas/Attempt" }

  /attempts/quiz/{quizId}:
    get:
      tags:
        - Attempts
      summary: Get user attempts
      description: Returns all attempts made by the logged-in user for a specific quiz.
      security:
        - BearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: List of attempts
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/Attempt" }

  # ==============================
  # LEADERBOARD ROUTES
  # ==============================
  /leaderboard:
    get:
      tags:
        - Leaderboard
      summary: Quiz-Specific Leaderboard
      description: Returns detailed stats (accuracy, time taken) for a specific quiz.
      parameters:
        - name: quizId
          in: query
          required: true
          schema: { type: integer }
          example: 1
        - name: limit
          in: query
          schema: { type: integer, default: 50 }
          description: Max number of records to return
      responses:
        "200":
          description: Leaderboard data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/LeaderboardEntry"

  # ==============================
  # UPLOAD ROUTES
  # ==============================
  /upload/upload:
    post:
      tags:
        - Upload
      summary: Upload image to Cloudinary
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [image]
              properties:
                image:
                  type: string
                  description: Base64 encoded image string
                  example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="
                folder:
                  type: string
                  default: "department-quiz/quiz-images"
                  example: "department-quiz/quiz-images"
      responses:
        "200":
          description: Upload successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      url:
                        {
                          type: string,
                          example: "https://res.cloudinary.com/...",
                        }
                      publicId: { type: string, example: "folder/image_id" }

  /upload/delete:
    delete:
      tags:
        - Upload
      summary: Delete image from Cloudinary
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [publicId]
              properties:
                publicId: { type: string, example: "folder/image_id" }
      responses:
        "200":
          description: Image deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message:
                    { type: string, example: "Image deleted successfully" }
